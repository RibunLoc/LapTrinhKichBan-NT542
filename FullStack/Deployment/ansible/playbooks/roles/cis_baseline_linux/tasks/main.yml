- name: Đảm bảo các gói được cập nhật
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600

- name: Cài đặt các gói cơ bản
  ansible.builtin.apt:
    name:
      - fail2ban
      - unattended-upgrades
      - auditd
    state: present

- name: Đảm bảo auditd đang chạy và khởi động cùng hệ thống
  ansible.builtin.service:
    name: auditd
    state: started
    enabled: yes

- name: Tạo user devops
  ansible.builtin.user:
    name: "{{ devops_user | default('devops') }}"
    shell: /bin/bash
    create_home: yes
    state: present

- name: Thêm devops user vào nhóm sudo
  ansible.builtin.user:
    name: "{{ devops_user | default('devops') }}"
    groups: sudo
    append: yes

- name: Tạo thư mục .ssh cho user devops
  ansible.builtin.file:
    path: "/home/{{ devops_user | default('devops') }}/.ssh"
    state: directory
    owner: "{{ devops_user | default('devops') }}"
    group: "{{ devops_user | default('devops') }}"
    mode: "0700"
  
- name: Cho phép devops sử dụng sudo không cần mật khẩu
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ devops_user | default('devops') }}"
    content: "{{ devops_user | default('devops') }} ALL=(ALL) NOPASSWD:ALL"
    owner: root
    group: root
    mode: "0440"


- name: Copy authorized_keys từ root vào devops user
  ansible.builtin.copy:
    src: /root/.ssh/authorized_keys
    dest: "/home/{{ devops_user | default('devops') }}/.ssh/authorized_keys"
    owner: "{{ devops_user | default('devops') }}"
    group: "{{ devops_user | default('devops') }}"
    mode: "0600"
    remote_src: yes

- name: Harden sshd - tắt PasswordAuthentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
    backup: yes

- name: Harden sshd - tắt PermitRootLogin
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present

- name: Khởi động lại sshd
  ansible.builtin.service:
    name: sshd
    state: reloaded
