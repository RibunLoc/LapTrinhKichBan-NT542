- name: Check sshd PermitRootLogin
  ansible.builtin.shell: "grep -E '^PermitRootLogin' /etc/ssh/sshd_config || true"
  register: permit_root
  changed_when: false

- name: Assert root login disabled
  ansible.builtin.assert:
    that:
      - "'PermitRootLogin no' in permit_root.stdout"
    fail_msg: "PermitRootLogin is not set to no"
    success_msg: "PermitRootLogin configured correctly"

- name: Check sshd PasswordAuthentication
  ansible.builtin.shell: "grep -E '^PasswordAuthentication' /etc/ssh/sshd_config || true"
  register: password_auth
  changed_when: false

- name: Assert password auth disabled
  ansible.builtin.assert:
    that:
      - "'PasswordAuthentication no' in password_auth.stdout"
    fail_msg: "PasswordAuthentication not disabled"
    success_msg: "PasswordAuthentication disabled"

- name: Check auditd service
  ansible.builtin.service_facts:

- name: Assert auditd running
  ansible.builtin.assert:
    that:
      - "'auditd.service' in ansible_facts.services"
      - "ansible_facts.services['auditd.service'].state == 'running'"
    fail_msg: "auditd not running"
    success_msg: "auditd running"

- name: Check unattended-upgrades package
  ansible.builtin.shell: "dpkg -l | grep unattended-upgrades || true"
  register: unattended_pkg
  changed_when: false

- name: Assert unattended-upgrades present
  ansible.builtin.assert:
    that:
      - unattended_pkg.stdout != ""
    fail_msg: "unattended-upgrades not installed"
    success_msg: "unattended-upgrades installed"
